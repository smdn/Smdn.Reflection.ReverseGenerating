<!--
SPDX-FileCopyrightText: 2021 smdn <smdn@smdn.jp>
SPDX-License-Identifier: MIT
-->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFrameworks>net6.0;net5.0;netcoreapp3.1</TargetFrameworks>
    <RootNamespace>Smdn.Reflection.ReverseGenerating.ListApi.MSBuild.Tasks</RootNamespace>
    <VersionPrefix>1.0.0</VersionPrefix>
    <VersionSuffix></VersionSuffix>
    <Nullable>enable</Nullable>
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
  </PropertyGroup>

  <PropertyGroup Label="packaging">
    <!-- <PackageValidationBaselineVersion>1.0.1</PackageValidationBaselineVersion> -->
    <!-- <NoPackageAnalysis>true</NoPackageAnalysis> -->
    <TargetsForTfmSpecificContentInPackage>$(TargetsForTfmSpecificContentInPackage);GenerateTaskPropsFiles</TargetsForTfmSpecificContentInPackage>
    <DevelopmentDependency>true</DevelopmentDependency>
    <BuildOutputTargetFolder>tasks</BuildOutputTargetFolder>
    <NoWarn>$(NoWarn);NU5100;NU5128</NoWarn>
  </PropertyGroup>

  <PropertyGroup Label="metadata">
    <Description>MSBuild tasks for reverse generation of API lists from assemblies.</Description>
    <CopyrightYear>2021</CopyrightYear>

    <!-- NuGet -->
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Build.Utilities.Core" Version="17.0.0" PrivateAssets="All" />
    <ProjectReference VersionRange="[1.0.0,2.0.0)" Include="..\Smdn.Reflection.ReverseGenerating.ListApi.Core\Smdn.Reflection.ReverseGenerating.ListApi.Core.csproj" />
  </ItemGroup>

  <ItemGroup>
    <ExportTaskName Include="GenerateApiList">
      <Namespace>Smdn.Reflection.ReverseGenerating.ListApi.MSBuild.Tasks</Namespace>
    </ExportTaskName>
  </ItemGroup>

  <Target Name="GenerateTaskPropsFiles">
    <GenerateTaskPropsFile
      TaskName="%(ExportTaskName.Identity)"
      TaskNamespace="%(ExportTaskName.Namespace)"
      TaskAssemblyFile="$(AssemblyName).dll"
      OutputDirectory="$(OutputPath)"
    >
      <Output PropertyName="GeneratedTaskPropsFile" TaskParameter="GeneratedFile" />
    </GenerateTaskPropsFile>

    <ItemGroup>
      <TfmSpecificPackageFile Include="$(GeneratedTaskPropsFile)" PackagePath="$(BuildOutputTargetFolder)\$(TargetFramework)" />
    </ItemGroup>
  </Target>

  <UsingTask
    TaskName="GenerateTaskPropsFile"
    TaskFactory="RoslynCodeTaskFactory"
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll"
  >
    <ParameterGroup>
      <TaskName ParameterType="System.String" Required="true" />
      <TaskNamespace ParameterType="System.String" />
      <TaskAssemblyFile ParameterType="System.String" Required="true" />
      <OutputDirectory ParameterType="System.String" Required="true" />
      <GeneratedFile ParameterType="System.String" Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Code Type="Fragment" Language="cs"><![CDATA[
        const string PropertyMSBuildThisFileDirectory = "\x24(MSBuildThisFileDirectory)";
        var path = Path.Combine(OutputDirectory, $"{TaskName}.task.props");
        var taskFullName = string.IsNullOrEmpty(TaskNamespace)
          ? TaskName
          : $"{TaskNamespace}.{TaskName}";
        var contents =
 @$"<Project>
  <UsingTask
    TaskName=""{taskFullName}""
    AssemblyFile=""{PropertyMSBuildThisFileDirectory}{TaskAssemblyFile}""
  />
</Project>
";

        File.WriteAllText(path, contents);

        GeneratedFile = path;
      ]]></Code>
    </Task>
  </UsingTask>
</Project>
